<!DOCTYPE html>
<html>
<head>
	<title>upload file for user data</title>

<script src="bower_components/jquery/dist/jquery.js"></script>
<script type="text/javascript" src="bower_components/js-xlsx//shim.js"></script>
<script src="bower_components/js-xlsx/dist/jszip.js"></script>
<script src="bower_components/js-xlsx/dist/cpexcel.js"></script>
<script src="bower_components/js-xlsx/dist/xlsx.js"></script>
<!-- ODS support -->
<script src="bower_components/js-xlsx/dist/ods.js"></script>
</head>
<body>
<br/><div id="fileurl"></div>
<pre id="out"></pre>
<br />
<script>
'use strict';
function to_csv(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var csv = XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);
		if(csv.length > 0){
			result.push("SHEET: " + sheetName);
			result.push("");
			result.push(csv);
		}
	});
	return result.join("\n");
}

function to_json(workbook) {
	var result = {};
	workbook.SheetNames.forEach(function(sheetName) {
		var roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		if(roa.length > 0){
			result[sheetName] = roa;
		}
	});
	// console.log(result);
	return result;
}

function process_wb(wb) {
	var output = to_json(wb);
	if(out.innerText === undefined) out.textContent = output;
	else out.innerText = output;
	if(typeof console !== 'undefined') 
		{
			console.log("output", new Date());
	  console.log(output);
	  var str="";
	  for (var i = 0; i < output.Sheet1.length; i++) {
	  	str+=output.Sheet1[i].name+"--"+output.Sheet1[i].age+"\n";
	  };
	  out.innerText=str;
	}
}

var url = "uploads/test.xlsx";

var oReq;
if(window.XMLHttpRequest) oReq = new XMLHttpRequest();
else if(window.ActiveXObject) oReq = new ActiveXObject('MSXML2.XMLHTTP.3.0');
else throw "XHR unavailable for your browser";

// document.getElementById('fileurl').innerHTML = '<a href="' + url + '">Download file</a>';

oReq.open("GET", url, true);

if(typeof Uint8Array !== 'undefined') {
	oReq.responseType = "arraybuffer";
	oReq.onload = function(e) {
		if(typeof console !== 'undefined') console.log("onload", new Date());
		var arraybuffer = oReq.response;
		var data = new Uint8Array(arraybuffer);
		var arr = new Array();
		for(var i = 0; i != data.length; ++i) arr[i] = String.fromCharCode(data[i]);
		var wb = XLSX.read(arr.join(""), {type:"binary"});
		process_wb(wb);
	};
} else {
	oReq.setRequestHeader("Accept-Charset", "x-user-defined");	
	oReq.onreadystatechange = function() { if(oReq.readyState == 4 && oReq.status == 200) {
		var ff = convertResponseBodyToText(oReq.responseBody);
		if(typeof console !== 'undefined') console.log("onload", new Date());
		var wb = XLSX.read(ff, {type:"binary"});
		process_wb(wb);
	} };
}

oReq.send();

</script>
</body>
</html>